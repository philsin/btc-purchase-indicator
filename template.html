<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>__TITLE__</title>
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<style>
  :root { color-scheme:dark; --bg:#0f1116; --fg:#e7e9ee; --muted:#8e95a5; --card:#151821; }
  html,body{margin:0;background:var(--bg);color:var(--fg);
    font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  h1{font-size:clamp(28px,4.5vw,44px);margin:0 0 12px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .chip{background:var(--card);border:1px solid #263041;border-radius:999px;padding:8px 12px;display:inline-flex;align-items:center;gap:8px}
  .dot{width:12px;height:12px;border-radius:50%;background:#fff}
  .btn,select{background:var(--card);border:1px solid #263041;border-radius:12px;padding:8px 10px;color:var(--fg);font:inherit;cursor:pointer}
  #fig{height:70vh;min-height:430px;background:var(--card);border-radius:14px;padding:8px;position:relative}
  .slider{width:100%}
  .stack{display:flex;flex-direction:column;gap:2px;font-size:0.95rem}

  /* hide Plotly default hover; we use our pinned panel */
  .hoverlayer{ display:none !important; }

  /* pinned hover panel – ultra compact (140 px) */
  #hoverBox{
    position:fixed; right:16px; bottom:16px; z-index:10;
    width:140px; min-width:140px; max-width:140px;
    background:rgba(18,22,30,0.88); border:1px solid #3b4455;
    border-radius:10px; padding:6px 6px;
    font-size:0.80rem; line-height:1.05rem;
    display:none; user-select:none;
    box-shadow:0 8px 24px rgba(0,0,0,.35);
  }
  #hoverBox .hdr{font-weight:700; margin-bottom:3px; color:#e7e9ee}
  #hoverBox .rowline{
    display:grid; grid-template-columns:auto 1fr;
    align-items:center; column-gap:3px; margin:0; padding:0;
  }
  #hoverBox .rowline span:first-child{white-space:nowrap}
  #hoverBox .rowline span:last-child{text-align:right; white-space:nowrap}

  /* line colors for hover rows (match chart lines) */
  .color-top{color:#22c55e !important;}       /* Top (+2σ) – green */
  .color-frothy{color:#86efac !important;}    /* Frothy (+1σ) – light green */
  .color-mid{color:#e5e7eb !important;}       /* PL Best Fit – white */
  .color-bear{color:#fca5a5 !important;}      /* Bear (-0.5σ) – light red */
  .color-support{color:#ef4444 !important;}   /* Support (-1.5σ) – red */
  .color-btc{color:#facc15 !important;}       /* BTC – yellow */
</style>
</head>
<body>
  <div class="wrap">
    <h1>BTC Purchase Indicator</h1>

    <div class="row" style="margin-bottom:8px;">
      <div class="chip"><span id="zoneDot" class="dot"></span><b>Price Zone:</b><span id="zoneTxt" style="margin-left:6px">—</span></div>
      <div class="row" style="gap:8px;">
        <label for="denom">Denomination</label>
        <select id="denom" style="min-width:6.0rem;">
          <option value="USD" selected>USD</option>
          <option value="Gold">Gold</option>
        </select>
      </div>
      <button class="btn" id="legendBtn">Legend</button>
    </div>

    <div class="row" style="margin:6px 0 2px;">
      <label for="dateSlider">View at date:</label>
      <label class="row" style="gap:6px;"><input type="checkbox" id="chkToday"/> Today</label>
    </div>
    <input id="dateSlider" class="slider" type="range" min="0" value="0" step="1"/>
    <div id="dateRead" class="stack" style="opacity:.95; margin:6px 0 12px 2px;"></div>

    <div id="fig"></div>
  </div>

  <!-- pinned hover box -->
  <div id="hoverBox"></div>

  <script type="application/json" id="figjson">__FIGJSON__</script>
  <script type="application/json" id="arrays">__ARRAYS__</script>

  <script>
    const FIG = JSON.parse(document.getElementById('figjson').textContent);
    const ARR = JSON.parse(document.getElementById('arrays').textContent);
    const figEl = document.getElementById('fig');

    // hide Plotly default hover because we use a pinned panel
    (FIG.data||[]).forEach(tr => tr.hoverinfo = 'skip');

    Plotly.newPlot(figEl, FIG.data, FIG.layout, {displaylogo:false, responsive:true});

    // indices exposed by layout.meta
    const META = FIG.layout.meta || {};
    const USD_MARK_IDX = META.USD_MARK_IDX;
    const GLD_MARK_IDX = META.GLD_MARK_IDX;

    // controls
    const denomSel = document.getElementById('denom');
    const legendBtn = document.getElementById('legendBtn');
    const slider = document.getElementById('dateSlider');
    const chkToday = document.getElementById('chkToday');
    const zoneTxt = document.getElementById('zoneTxt');
    const zoneDot = document.getElementById('zoneDot');
    const dateRead = document.getElementById('dateRead');

    // dates & constants
    const fullISO = ARR.dates;
    const fullMS  = fullISO.map(d => Date.parse(d+"T00:00:00Z"));
    const histISO = ARR.hist.dates;
    const histMS  = histISO.map(d => Date.parse(d+"T00:00:00Z"));
    const genesisMS = Date.parse("2009-01-03T00:00:00Z");
    const MS_DAY = 86400000;

    // cutoff for BTC display in hover (6 months after last historical point)
    const LAST_HIST_MS = histMS[histMS.length-1];
    const CUTOFF_MS = (() => {
      const d = new Date(LAST_HIST_MS);
      d.setUTCMonth(d.getUTCMonth() + 6);
      return d.getTime();
    })();

    // crosshair & guides (semi-transparent)
    let hoverShapes = { v: null, h: null };
    let guideShapes = { v: null, h: null };
    function refreshShapes(){
      const arr = [];
      if (guideShapes.v) arr.push(guideShapes.v);
      if (guideShapes.h) arr.push(guideShapes.h);
      if (hoverShapes.v) arr.push(hoverShapes.v);
      if (hoverShapes.h) arr.push(hoverShapes.h);
      Plotly.relayout(figEl, { shapes: arr });
    }
    function setHoverCrosshair(x,y){
      const w="rgba(255,255,255,0.6)";
      hoverShapes.v={type:"line",xref:"x",x0:x,x1:x,yref:"paper",y0:0,y1:1,line:{color:w,width:1}};
      hoverShapes.h={type:"line",xref:"paper",x0:0,x1:1,yref:"y",y0:y,y1:y,line:{color:w,width:1}};
      refreshShapes();
    }
    function clearHoverCrosshair(){ hoverShapes.v=null; hoverShapes.h=null; refreshShapes(); }
    function setMarkerGuides(x,y){
      const yel="rgba(250,204,21,0.55)";
      guideShapes.v={type:"line",xref:"x",x0:x,x1:x,yref:"paper",y0:0,y1:1,line:{color:yel,width:1}};
      guideShapes.h={type:"line",xref:"paper",x0:0,x1:1,yref:"y",y0:y,y1:y,line:{color:yel,width:1}};
      refreshShapes();
    }
    function clearMarkerGuides(){ guideShapes.v=null; guideShapes.h=null; refreshShapes(); }

    // utilities
    function fmtUSD(v){ return (v==null||!isFinite(v))?"—":"$"+Math.round(v).toLocaleString(); }
    function fmtOzBTC(v){
      if (v==null||!isFinite(v)) return "—";
      const n = Math.round(v*100)/100;
      return n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})+" oz/BTC";
    }
    function fmtMonthYear(iso){
      const d = new Date(iso+"T00:00:00Z");
      return d.toLocaleString('en-US', {month:'short', year:'numeric'});
    }
    function fmtTickGold(v){
      if (!isFinite(v)||v<=0) return "";
      if (v>=1) return Math.round(v).toLocaleString();
      return Number(v).toFixed(3).replace(/\.?0+$/,"");
    }
    function nearestIdx(ms, arrMS){
      let lo=0, hi=arrMS.length-1, pos=hi;
      while (lo<=hi){ const mid=(lo+hi)>>1; if (arrMS[mid]>=ms){pos=mid; hi=mid-1;} else lo=mid+1; }
      if (pos>0 && Math.abs(arrMS[pos-1]-ms)<=Math.abs(arrMS[pos]-ms)) return pos-1;
      return pos;
    }
    function zoneDotColor(z){
      switch(z){
        case "SELL THE HOUSE!!": return "#ffffff";
        case "Buy":              return "#f97316";
        case "DCA":              return "#ffffff";
        case "Relax":            return "#84cc16";
        case "Frothy":           return "#ef4444";
        default:                 return "#e5e7eb";
      }
    }
    function bandsAtIdx(idx, denom){
      const g = denom==="USD" ? ARR.usd : ARR.gld;
      return {Support:g.Support[idx], Bear:g.Bear[idx], Mid:g.Mid[idx], Frothy:g.Frothy[idx], Top:g.Top[idx]};
    }

    /* ───────── Legend toggle (simple) ───────── */
    function legendIsOn(){ return !!(figEl._fullLayout && figEl._fullLayout.showlegend); }
    async function toggleLegend(){
      const want = !legendIsOn();
      await Plotly.relayout(figEl, { showlegend: !!want });
      setTimeout(()=>{},0); // help Safari catch up
    }
    legendBtn.addEventListener('click', toggleLegend, { passive:true });
    legendBtn.addEventListener('touchend', (e)=>{ e.preventDefault(); toggleLegend(); }, { passive:false });
    /* ────────────────────────────────────────── */

    // denomination toggle (per-trace visibility via legendgroup)
    function setGoldTicks(){
      const G = ARR.gld;
      const all = [].concat(G.Support,G.Bear,G.Mid,G.Frothy,G.Top,ARR.hist.gld).filter(v=>v>0&&isFinite(v));
      if (!all.length) return;
      const minV = Math.min.apply(null,all), maxV = Math.max.apply(null,all);
      const c = [0.01,0.02,0.05,0.1,0.2,0.5,1,2,5,10,20,50,100,200,500,1000];
      const ticks = c.filter(v=>v>=minV*0.9 && v<=maxV*1.1);
      Plotly.relayout(figEl, {"yaxis.tickvals":ticks, "yaxis.ticktext":ticks.map(fmtTickGold), "yaxis.tickformat":""});
    }
    function clearGoldTicks(){
      Plotly.relayout(figEl, {"yaxis.tickvals":null, "yaxis.ticktext":null, "yaxis.tickformat":"$,d"});
    }
    function setDenom(which){
      const want = which==="USD" ? "USD" : "GLD";
      const traces = figEl.data || [];
      traces.forEach((tr,i)=>{
        const vis = (tr.legendgroup||"") === want;
        Plotly.restyle(figEl, {"visible": vis}, [i]);
      });
      if (which==="USD"){ Plotly.relayout(figEl, {"yaxis.title.text":"USD / BTC"}); clearGoldTicks(); }
      else { Plotly.relayout(figEl, {"yaxis.title.text":"Gold oz / BTC"}); setGoldTicks(); }
      updateMarkerAndReadout();
      if (window._lastPinnedX != null) updatePinnedHoverFromX(window._lastPinnedX);
      if (chkToday.checked){ setTimeout(()=> setToday(true), 0); }
    }
    denomSel.addEventListener('change', e => setDenom(e.target.value));

    // weekly slider (Mondays)
    (function initWeekly(){
      const firstDate = new Date(histMS[0]);
      const firstMon = histMS[0] + ((8 - firstDate.getUTCDay()) % 7) * MS_DAY;
      const weeklyIdx = [];
      for (let t = firstMon; t <= histMS[histMS.length-1]; t += 7*MS_DAY)
        weeklyIdx.push(nearestIdx(t, histMS));
      if (weeklyIdx.length===0) weeklyIdx.push(histMS.length-1);
      slider._weeklyIdx = weeklyIdx;
      slider.max = Math.max(0, weeklyIdx.length-1);
      slider.value = slider.max;
    })();

    function sliderToHistIndex(){
      const i = Math.max(0, Math.min(parseInt(slider.value,10), slider._weeklyIdx.length-1));
      return slider._weeklyIdx[i] ?? (histMS.length-1);
    }

    // pinned hover rendering (140px wide panel; colors match lines)
    const LINE_CLASS = {
      "Top": "color-top",
      "Frothy": "color-frothy",
      "PL Best Fit": "color-mid",
      "Bear": "color-bear",
      "Support": "color-support",
      "BTC": "color-btc"
    };
    function renderHoverBox(monthLabel, rows){
      const hb = document.getElementById("hoverBox");
      const body = rows.map(r=>{
        const cls = LINE_CLASS[r.name] || "";
        return `<div class="rowline">
                  <span class="${cls}">${r.name}</span>
                  <span class="${cls}">${r.value}</span>
                </div>`;
      }).join("");
      hb.innerHTML = `<div class="hdr">${monthLabel}</div>${body}`;
      hb.style.display = "block";
    }

    // marker & readout
    function updateMarkerAndReadout(){
      const j = sliderToHistIndex();
      const denom = denomSel.value;
      const dISO = histISO[j];
      const priceUSD = ARR.hist.usd[j];
      const priceGLD = ARR.hist.gld[j];

      // zone from bands at nearest full date
      const ms = Date.parse(dISO+"T00:00:00Z");
      const k = nearestIdx(ms, fullMS);
      const b = bandsAtIdx(k, denom);
      const price = denom==="USD" ? priceUSD : priceGLD;
      const zone = (price < b.Support) ? "SELL THE HOUSE!!"
                 : (price < b.Bear)    ? "Buy"
                 : (price < b.Frothy)  ? "DCA"
                 : (price < b.Top)     ? "Relax"
                 : "Frothy";
      zoneTxt.textContent = zone;
      zoneDot.style.background = zoneDotColor(zone);

      // readout: only date + BTC price
      const line = denom==="USD" ? fmtUSD(priceUSD) : fmtOzBTC(priceGLD);
      dateRead.innerHTML = `<div style="font-weight:600">${dISO}</div><div>BTC: ${line}</div>`;

      // move yellow marker + guides
      const days = Math.max(1, Math.round((Date.parse(dISO+"T00:00:00Z") - genesisMS)/MS_DAY));
      const xval = Math.log10(days);
      if (denom==="USD"){
        Plotly.restyle(figEl, {"x":[[xval]], "y":[[priceUSD]]}, [USD_MARK_IDX]);
        if (!chkToday.checked) setMarkerGuides(xval, priceUSD); else clearMarkerGuides();
      } else {
        Plotly.restyle(figEl, {"x":[[xval]], "y":[[priceGLD]]}, [GLD_MARK_IDX]);
        if (!chkToday.checked) setMarkerGuides(xval, priceGLD); else clearMarkerGuides();
      }
    }

    // ───────── Today toggle: jump to latest, clear guides, sync panel ─────────
    function latestHistIndex(){ return Math.max(0, histMS.length - 1); }
    function latestLogX(){
      const ms = histMS[latestHistIndex()];
      const days = Math.max(1, Math.round((ms - genesisMS)/MS_DAY));
      return Math.log10(days);
    }
    function setToday(on){
      chkToday.checked = !!on;
      if (on){
        slider.value = slider.max;           // newest weekly slot
        clearMarkerGuides();                 // no yellow guides on Today
        updateMarkerAndReadout();            // dot + zone
        setTimeout(()=> updatePinnedHoverFromX(latestLogX()), 0); // pinned panel
      } // else: slider handlers restore guides
    }
    const onTodayClick = (e)=>{ e.preventDefault(); setToday(!chkToday.checked); };
    chkToday.addEventListener('click',     onTodayClick, {passive:false});
    chkToday.addEventListener('touchend',  onTodayClick, {passive:false});
    chkToday.addEventListener('change',   ()=> setToday(chkToday.checked));
    // ─────────────────────────────────────────────────────────────────────────

    // ───────── Slider: leave Today mode, update guides + pinned panel ───────
    function updatePinnedAtSlider(){
      const i = sliderToHistIndex();
      const ms = histMS[i];
      const days = Math.max(1, Math.round((ms - genesisMS)/MS_DAY));
      updatePinnedHoverFromX(Math.log10(days));
    }
    function onSliderInteract(){
      if (chkToday.checked) chkToday.checked = false;  // exit Today mode
      updateMarkerAndReadout();    // moves yellow dot + sets guides
      updatePinnedAtSlider();      // refresh pinned hover to slider date
    }
    slider.addEventListener('input',    onSliderInteract, {passive:true});
    slider.addEventListener('change',   onSliderInteract, {passive:true});
    slider.addEventListener('touchend', onSliderInteract, {passive:true});
    // ─────────────────────────────────────────────────────────────────────────

    // pinned hover (hover & click) → month-year + colored rows
    function updatePinnedHoverFromX(logx){
      window._lastPinnedX = logx;
      const days = Math.max(1, Math.round(Math.pow(10, logx)));
      const ms = genesisMS + days*MS_DAY;
      const idxFull = nearestIdx(ms, fullMS);
      const idxHist = nearestIdx(ms, histMS);
      const dateISO = fullISO[idxFull];
      const denom = denomSel.value;
      const b = bandsAtIdx(idxFull, denom);
      const usd = ARR.hist.usd[idxHist];
      const gld = ARR.hist.gld[idxHist];

      const showBTC = (ms <= CUTOFF_MS);   // ← hide BTC beyond +6 months

      const monthLabel = fmtMonthYear(dateISO);
      const rows = (denom==="USD")
        ? [
            {name:"Top",        value: fmtUSD(b.Top)},
            {name:"Frothy",     value: fmtUSD(b.Frothy)},
            {name:"PL Best Fit",value: fmtUSD(b.Mid)},
            {name:"Bear",       value: fmtUSD(b.Bear)},
            {name:"Support",    value: fmtUSD(b.Support)},
            ...(showBTC ? [{name:"BTC", value: fmtUSD(usd)}] : [])
          ]
        : [
            {name:"Top",        value: fmtOzBTC(b.Top)},
            {name:"Frothy",     value: fmtOzBTC(b.Frothy)},
            {name:"PL Best Fit",value: fmtOzBTC(b.Mid)},
            {name:"Bear",       value: fmtOzBTC(b.Bear)},
            {name:"Support",    value: fmtOzBTC(b.Support)},
            ...(showBTC ? [{name:"BTC", value: fmtOzBTC(gld)}] : [])
          ];
      renderHoverBox(monthLabel, rows);
    }

    // hide hover/crosshair on outside tap
    function outsideFig(el, target){ return !el.contains(target); }
    function hideHover(){ try{ Plotly.Fx.unhover(figEl); }catch(e){} clearHoverCrosshair(); }
    document.addEventListener('click', (ev)=>{ if(outsideFig(figEl, ev.target)) hideHover(); }, {passive:true});
    document.addEventListener('touchstart', (ev)=>{ if(outsideFig(figEl, ev.target)) hideHover(); }, {passive:true});

    figEl.on('plotly_hover', (ev) => {
      if (!ev || !ev.points || !ev.points.length) return;
      const p = ev.points[0]; setHoverCrosshair(p.x, p.y); updatePinnedHoverFromX(p.x);
    });
    figEl.on('plotly_click', (ev) => {
      if (!ev || !ev.points || !ev.points.length) return;
      const p = ev.points[0]; setHoverCrosshair(p.x, p.y); updatePinnedHoverFromX(p.x);
    });
    figEl.on('plotly_unhover', () => { clearHoverCrosshair(); });

    // init
    setDenom("USD");
    updateMarkerAndReadout();
    (function initPinned(){
      const lastISO = histISO.at(-1);
      const ms = Date.parse(lastISO+"T00:00:00Z");
      const days = Math.max(1, Math.round((ms - genesisMS)/MS_DAY));
      updatePinnedHoverFromX(Math.log10(days));
      document.getElementById("hoverBox").style.display = "block";
    })();

    window.addEventListener('resize', ()=> Plotly.Plots.resize(figEl));
  </script>
</body>
</html>