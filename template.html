<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>__TITLE__</title>
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<style>
  :root { color-scheme:dark; --bg:#0f1116; --fg:#e7e9ee; --muted:#8e95a5; --card:#151821; }
  html,body{margin:0;background:var(--bg);color:var(--fg);
    font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1180px;margin:24px auto;padding:0 16px}
  h1{font-size:clamp(28px,4.5vw,44px);margin:0 0 12px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .chip{background:var(--card);border:1px solid #263041;border-radius:999px;padding:8px 12px;display:inline-flex;align-items:center;gap:8px}
  .dot{width:12px;height:12px;border-radius:50%;background:#fff}
  .btn,select,input[type="date"]{background:var(--card);border:1px solid #263041;border-radius:12px;padding:8px 10px;color:var(--fg);font:inherit;cursor:pointer}
  #fig{height:72vh;min-height:460px;background:var(--card);border-radius:14px;padding:8px;position:relative}
  .slider{width:100%}
  .stack{display:flex;flex-direction:column;gap:2px;font-size:0.95rem}

  /* pinned hover panel */
  #hoverBox{
    position:fixed; right:16px; bottom:16px; z-index:10;
    width:140px; min-width:140px; max-width:140px;
    background:rgba(18,22,30,0.88); border:1px solid #3b4455;
    border-radius:10px; padding:6px 6px;
    font-size:0.80rem; line-height:1.05rem; display:block; user-select:none;
    box-shadow:0 8px 24px rgba(0,0,0,.35);
  }
  #hoverBox .hdr{font-weight:700; margin-bottom:3px; color:#e7e9ee}
  #hoverBox .rowline{
    display:grid; grid-template-columns:auto 1fr;
    align-items:center; column-gap:3px; margin:0; padding:0;
  }
  #hoverBox .rowline span:first-child{white-space:nowrap}
  #hoverBox .rowline span:last-child{text-align:right; white-space:nowrap}

  .color-top{color:#22c55e !important;}
  .color-frothy{color:#86efac !important;}
  .color-mid{color:#e5e7eb !important;}
  .color-bear{color:#fca5a5 !important;}
  .color-support{color:#ef4444 !important;}
  .color-btc{color:#facc15 !important;}

  /* hide Plotly default hover */
  .hoverlayer{ display:none !important; }
</style>
</head>
<body>
  <div class="wrap">
    <h1>BTC Purchase Indicator</h1>

    <div class="row" style="margin-bottom:8px;">
      <div class="chip"><span id="zoneDot" class="dot"></span><b>Price Zone:</b><span id="zoneTxt" style="margin-left:6px">—</span></div>

      <div class="row" style="gap:8px;">
        <label for="denom">Denomination</label>
        <select id="denom" style="min-width:6.0rem;">
          <option value="USD" selected>USD</option>
          <option value="Gold">Gold</option>
          <option value="SPY">SPY</option>
        </select>
      </div>

      <label class="row" style="gap:6px; margin-left:4px;"><input type="checkbox" id="compare"/> Compare</label>

      <button class="btn" id="panelBtn">Panel</button>
      <button class="btn" id="exportBtn">Export</button>
    </div>

    <div class="row" style="gap:10px; margin:6px 0 8px;">
      <label for="dateSlider">View (Wednesdays):</label>
      <label class="row" style="gap:6px;"><input type="checkbox" id="chkToday"/> Today</label>

      <div class="row" style="gap:6px;">
        <label for="datePick">Jump</label>
        <input id="datePick" type="date"/>
      </div>

      <div class="row" style="gap:6px;">
        <label for="bandSel">Band</label>
        <select id="bandSel">
          <option value="Top">Top</option>
          <option value="Frothy">Frothy</option>
          <option value="Mid">PL Best Fit</option>
          <option value="Bear">Bear</option>
          <option value="Support">Support</option>
        </select>
        <button class="btn" id="prevBand">Prev</button>
        <button class="btn" id="nextBand">Next</button>
      </div>
    </div>

    <input id="dateSlider" class="slider" type="range" min="0" value="0" step="1"/>
    <div id="dateRead" class="stack" style="opacity:.95; margin:6px 0 12px 2px;"></div>

    <div id="fig"></div>
  </div>

  <div id="hoverBox"></div>

  <script type="application/json" id="figjson">__FIGJSON__</script>
  <script type="application/json" id="arrays">__ARRAYS__</script>

  <script>
    const FIG = JSON.parse(document.getElementById('figjson').textContent);
    const ARR = JSON.parse(document.getElementById('arrays').textContent);
    const figEl = document.getElementById('fig');

    // Hide default hover
    (FIG.data||[]).forEach(tr => tr.hoverinfo = 'skip');

    Plotly.newPlot(figEl, FIG.data, FIG.layout, {displaylogo:false, responsive:true});

    const META = FIG.layout.meta || {};
    const USD_MARK_IDX = META.USD_MARK_IDX, GLD_MARK_IDX = META.GLD_MARK_IDX, SPY_MARK_IDX = META.SPY_MARK_IDX;

    // Controls
    const denomSel = document.getElementById('denom');
    const compareChk = document.getElementById('compare');
    const panelBtn  = document.getElementById('panelBtn');
    const exportBtn = document.getElementById('exportBtn');
    const slider    = document.getElementById('dateSlider');
    const chkToday  = document.getElementById('chkToday');
    const zoneTxt   = document.getElementById('zoneTxt');
    const zoneDot   = document.getElementById('zoneDot');
    const dateRead  = document.getElementById('dateRead');
    const hoverBox  = document.getElementById('hoverBox');
    const datePick  = document.getElementById('datePick');
    const bandSel   = document.getElementById('bandSel');
    const prevBand  = document.getElementById('prevBand');
    const nextBand  = document.getElementById('nextBand');

    const fullISO = ARR.dates;
    const fullMS = fullISO.map(d => Date.parse(d+"T00:00:00Z"));
    const histISO = ARR.hist.dates;
    const histMS  = histISO.map(d => Date.parse(d+"T00:00:00Z"));
    const genesisMS = Date.parse("2009-01-03T00:00:00Z");
    const MS_DAY = 86400000;

    const LAST_HIST_MS = histMS[histMS.length-1];
    const CUTOFF_MS = (()=>{ const d=new Date(LAST_HIST_MS); d.setUTCMonth(d.getUTCMonth()+6); return d.getTime(); })();

    // Wednesday slider index
    const wedIdx = [];
    for (let i=0;i<histMS.length;i++){
      const dt = new Date(histMS[i]);
      if (dt.getUTCDay() === 3) wedIdx.push(i);  // Wednesday
    }
    if (wedIdx.length===0) wedIdx.push(histMS.length-1);
    slider.max = wedIdx.length-1; slider.value = wedIdx.length-1;
    datePick.min = histISO[0]; datePick.max = histISO[histISO.length-1]; datePick.value = histISO.at(-1);

    // Shapes
    let hoverShapes = { v:null, h:null };
    let guideShapes = { v:null, h:null };
    function refreshShapes(){
      const arr = [];
      if (guideShapes.v) arr.push(guideShapes.v);
      if (guideShapes.h) arr.push(guideShapes.h);
      if (hoverShapes.v) arr.push(hoverShapes.v);
      if (hoverShapes.h) arr.push(hoverShapes.h);
      Plotly.relayout(figEl, { shapes: (FIG.layout.shapes||[]).concat(arr) });
    }
    function setHoverCrosshair(x,y){
      if (!panelOn) return;
      const w="rgba(255,255,255,0.6)";
      hoverShapes.v={type:"line",xref:"x",x0:x,x1:x,yref:"paper",y0:0,y1:1,line:{color:w,width:1}};
      hoverShapes.h={type:"line",xref:"paper",x0:0,x1:1,yref:"y",y0:y,y1:y,line:{color:w,width:1}};
      refreshShapes();
    }
    function clearHoverCrosshair(){ hoverShapes.v=null; hoverShapes.h=null; refreshShapes(); }
    function setMarkerGuides(x,y){
      const yel="rgba(250,204,21,0.55)";
      guideShapes.v={type:"line",xref:"x",x0:x,x1:x,yref:"paper",y0:0,y1:1,line:{color:yel,width:1}};
      guideShapes.h={type:"line",xref:"paper",x0:0,x1:1,yref:"y",y0:y,y1:y,line:{color:yel,width:1}};
      refreshShapes();
    }
    function clearMarkerGuides(){ guideShapes.v=null; guideShapes.h=null; refreshShapes(); }

    function fmtUSD(v){ return (v==null||!isFinite(v))?"—":"$"+Math.round(v).toLocaleString(); }
    function fmtOzBTC(v){
      if (v==null||!isFinite(v)) return "—";
      const n = Math.round(v*100)/100;
      return n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})+" oz/BTC";
    }
    function fmtSPY(v){
      if (v==null||!isFinite(v)) return "—";
      const n = Math.round(v*100)/100;
      return n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})+" SPY/BTC";
    }
    function fmtMonthYear(iso){
      const d = new Date(iso+"T00:00:00Z");
      return d.toLocaleString('en-US', {month:'short', year:'numeric'});
    }
    function zoneDotColor(z){
      switch(z){
        case "SELL THE HOUSE!!": return "#ffffff";
        case "Buy":              return "#f97316";
        case "DCA":              return "#ffffff";
        case "Relax":            return "#84cc16";
        case "Frothy":           return "#ef4444";
        default:                 return "#e5e7eb";
      }
    }
    function bandsAtIdx(idx, denom){
      const g = denom==="USD" ? ARR.usd : denom==="Gold" ? ARR.gld : ARR.spy;
      return {Support:g.Support[idx], Bear:g.Bear[idx], Mid:g.Mid[idx], Frothy:g.Frothy[idx], Top:g.Top[idx]};
    }

    // Panel toggle
    let panelOn = true;
    function setPanel(on){
      panelOn = !!on;
      hoverBox.style.display = panelOn ? "block" : "none";
      if (!panelOn) clearHoverCrosshair();
    }
    panelBtn.addEventListener('click', ()=> setPanel(!panelOn), {passive:true});

    // Denomination & comparison
    function setYAxisTitle(primary){
      const title = primary==="USD" ? "USD / BTC" : primary==="Gold" ? "Gold oz / BTC" : "SPY / BTC";
      Plotly.relayout(figEl, {"yaxis.title.text": title, "yaxis.tickformat": (primary==="USD"?"$,d":"")});
    }
    function visibleForGroup(group, wantVisible){
      (figEl.data||[]).forEach((tr,i)=>{
        if ((tr.legendgroup||"")===group){
          Plotly.restyle(figEl, {"visible": wantVisible}, [i]);
        }
      });
    }
    function setDenom(primary){
      const comp = compareChk.checked;
      setYAxisTitle(primary);
      // All off
      visibleForGroup("USD", false);
      visibleForGroup("GLD", false);
      visibleForGroup("SPY", false);
      // Primary on
      visibleForGroup(primary==="USD"?"USD":(primary==="Gold"?"GLD":"SPY"), true);
      // Comparison: also show the other groups' band areas + BTC lines
      if (comp){
        if (primary!=="USD")  visibleForGroup("USD", true);
        if (primary!=="Gold") visibleForGroup("GLD", true);
        if (primary!=="SPY")  visibleForGroup("SPY", true);
      }
      updateMarkerAndReadout();
      if (window._lastPinnedX != null) updatePinnedHoverFromX(window._lastPinnedX);
    }
    denomSel.addEventListener('change', e => setDenom(e.target.value));
    compareChk.addEventListener('change', ()=> setDenom(denomSel.value));

    // Pinned hover
    const LINE_CLASS = { "Top":"color-top","Frothy":"color-frothy","Mid":"color-mid","Bear":"color-bear","Support":"color-support","BTC":"color-btc" };
    function renderHoverBox(monthLabel, rows){
      if (!panelOn) return;
      const body = rows.map(r=>{
        const cls = LINE_CLASS[r.name] || "";
        return `<div class="rowline"><span class="${cls}">${r.name}</span><span class="${cls}">${r.value}</span></div>`;
      }).join("");
      hoverBox.innerHTML = `<div class="hdr">${monthLabel}</div>${body}`;
    }

    function zoneFor(price, b){
      if (price < b.Support) return "SELL THE HOUSE!!";
      if (price < b.Bear)    return "Buy";
      if (price < b.Frothy)  return "DCA";
      if (price < b.Top)     return "Relax";
      return "Frothy";
    }

    function sliderToHistIndex(){ const i = Math.max(0, Math.min(parseInt(slider.value,10), wedIdx.length-1)); return wedIdx[i]; }

    function updateMarkerAndReadout(){
      const j = sliderToHistIndex();
      const denom = denomSel.value;
      const dISO = histISO[j];
      const priceUSD = ARR.hist.usd[j];
      const priceGLD = ARR.hist.gld[j];
      const priceSPY = ARR.hist.spy[j];

      const ms = Date.parse(dISO+"T00:00:00Z");
      const k = (function(){ // nearest full index
        let lo=0,hi=fullMS.length-1,pos=hi;
        while(lo<=hi){ const m=(lo+hi)>>1; if(fullMS[m]>=ms){pos=m;hi=m-1}else lo=m+1}
        if (pos>0 && Math.abs(fullMS[pos-1]-ms)<=Math.abs(fullMS[pos]-ms)) return pos-1;
        return pos;
      })();

      const b = bandsAtIdx(k, denom);
      const cur = denom==="USD" ? priceUSD : denom==="Gold" ? priceGLD : priceSPY;
      const zone = zoneFor(cur, b);
      zoneTxt.textContent = zone; zoneDot.style.background = zoneDotColor(zone);

      // slider read
      const vUSD = fmtUSD(priceUSD);
      const vGLD = fmtOzBTC(priceGLD);
      const vSPY = fmtSPY(priceSPY);
      const v = denom==="USD" ? vUSD : denom==="Gold" ? vGLD : vSPY;
      dateRead.innerHTML = `<div style="font-weight:600">${dISO}</div><div>BTC: ${v}</div>`;

      // move yellow marker & guides
      const days = Math.max(1, Math.round((ms - genesisMS)/MS_DAY));
      const xval = Math.log10(days);
      if (denom==="USD"){
        Plotly.restyle(figEl, {"x":[[xval]], "y":[[priceUSD]]}, [USD_MARK_IDX]);
        Plotly.restyle(figEl, {"visible":[true]}, [USD_MARK_IDX]);
        Plotly.restyle(figEl, {"visible":[false]}, [GLD_MARK_IDX, SPY_MARK_IDX]);
        if (!chkToday.checked) setMarkerGuides(xval, priceUSD); else clearMarkerGuides();
      } else if (denom==="Gold"){
        Plotly.restyle(figEl, {"x":[[xval]], "y":[[priceGLD]]}, [GLD_MARK_IDX]);
        Plotly.restyle(figEl, {"visible":[true]}, [GLD_MARK_IDX]);
        Plotly.restyle(figEl, {"visible":[false]}, [USD_MARK_IDX, SPY_MARK_IDX]);
        if (!chkToday.checked) setMarkerGuides(xval, priceGLD); else clearMarkerGuides();
      } else {
        Plotly.restyle(figEl, {"x":[[xval]], "y":[[priceSPY]]}, [SPY_MARK_IDX]);
        Plotly.restyle(figEl, {"visible":[true]}, [SPY_MARK_IDX]);
        Plotly.restyle(figEl, {"visible":[false]}, [USD_MARK_IDX, GLD_MARK_IDX]);
        if (!chkToday.checked) setMarkerGuides(xval, priceSPY); else clearMarkerGuides();
      }
    }

    function fmtMonthYear(iso){
      const d = new Date(iso+"T00:00:00Z");
      return d.toLocaleString('en-US', {month:'short', year:'numeric'});
    }

    function updatePinnedHoverFromX(logx){
      window._lastPinnedX = logx;
      const days = Math.max(1, Math.round(Math.pow(10, logx)));
      const ms = genesisMS + days*MS_DAY;
      // nearest indices
      let lo=0,hi=fullMS.length-1,pos=hi;
      while(lo<=hi){ const m=(lo+hi)>>1; if(fullMS[m]>=ms){pos=m;hi=m-1}else lo=m+1}
      if (pos>0 && Math.abs(fullMS[pos-1]-ms)<=Math.abs(fullMS[pos]-ms)) pos=pos-1;
      const k = pos;

      lo=0;hi=histMS.length-1;pos=hi;
      while(lo<=hi){ const m=(lo+hi)>>1; if(histMS[m]>=ms){pos=m;hi=m-1}else lo=m+1}
      if (pos>0 && Math.abs(histMS[pos-1]-ms)<=Math.abs(histMS[pos]-ms)) pos=pos-1;
      const j = pos;

      const denom = denomSel.value;
      const b = bandsAtIdx(k, denom);
      const iso = fullISO[k];

      const usd = ARR.hist.usd[j], gld = ARR.hist.gld[j], spy = ARR.hist.spy[j];
      const showBTC = (ms <= CUTOFF_MS);

      const rows = (denom==="USD") ? [
        {name:"Top",        value: fmtUSD(b.Top)},
        {name:"Frothy",     value: fmtUSD(b.Frothy)},
        {name:"Mid",        value: fmtUSD(b.Mid)},
        {name:"Bear",       value: fmtUSD(b.Bear)},
        {name:"Support",    value: fmtUSD(b.Support)},
        ...(showBTC ? [{name:"BTC", value: fmtUSD(usd)}] : [])
      ] : (denom==="Gold") ? [
        {name:"Top",        value: fmtOzBTC(b.Top)},
        {name:"Frothy",     value: fmtOzBTC(b.Frothy)},
        {name:"Mid",        value: fmtOzBTC(b.Mid)},
        {name:"Bear",       value: fmtOzBTC(b.Bear)},
        {name:"Support",    value: fmtOzBTC(b.Support)},
        ...(showBTC ? [{name:"BTC", value: fmtOzBTC(gld)}] : [])
      ] : [
        {name:"Top",        value: fmtSPY(b.Top)},
        {name:"Frothy",     value: fmtSPY(b.Frothy)},
        {name:"Mid",        value: fmtSPY(b.Mid)},
        {name:"Bear",       value: fmtSPY(b.Bear)},
        {name:"Support",    value: fmtSPY(b.Support)},
        ...(showBTC ? [{name:"BTC", value: fmtSPY(spy)}] : [])
      ];

      renderHoverBox(fmtMonthYear(iso), rows);
    }

    // Today
    function todayJump(){
      slider.value = slider.max;
      datePick.value = histISO.at(-1);
      clearMarkerGuides();
      updateMarkerAndReadout();
      const ms = histMS[histMS.length-1];
      const days = Math.max(1, Math.round((ms - genesisMS)/MS_DAY));
      updatePinnedHoverFromX(Math.log10(days));
    }
    chkToday.addEventListener('change', ()=>{ if (chkToday.checked) todayJump(); });

    // Slider
    function onSlider(){
      if (chkToday.checked) chkToday.checked = false;
      const j = sliderToHistIndex();
      datePick.value = histISO[j];
      updateMarkerAndReadout();
      const ms = histMS[j];
      const days = Math.max(1, Math.round((ms - genesisMS)/MS_DAY));
      updatePinnedHoverFromX(Math.log10(days));
    }
    slider.addEventListener('input', onSlider);
    slider.addEventListener('change', onSlider);

    // Date picker → nearest Wednesday index
    datePick.addEventListener('change', ()=>{
      const ms = Date.parse(datePick.value+"T00:00:00Z");
      // nearest daily index, then find nearest wedIdx position
      let lo=0,hi=histMS.length-1,pos=hi;
      while(lo<=hi){ const m=(lo+hi)>>1; if(histMS[m]>=ms){pos=m;hi=m-1}else lo=m+1}
      if (pos>0 && Math.abs(histMS[pos-1]-ms)<=Math.abs(histMS[pos]-ms)) pos=pos-1;
      // nearest Wednesday slot
      let best=0, bestd=1e18;
      for (let k=0;k<wedIdx.length;k++){
        const d = Math.abs(wedIdx[k]-pos);
        if (d<bestd){ bestd=d; best=k; }
      }
      slider.value = best;
      chkToday.checked = false;
      onSlider();
    });

    // Click on chart → snap to nearest historical day (then to nearest Wednesday slot)
    figEl.on('plotly_click', (ev)=>{
      if (!ev || !ev.points || !ev.points.length) return;
      const p = ev.points[0];
      const days = Math.max(1, Math.round(Math.pow(10, p.x)));
      const ms = genesisMS + days*MS_DAY;
      // nearest daily index
      let lo=0,hi=histMS.length-1,pos=hi;
      while(lo<=hi){ const m=(lo+hi)>>1; if(histMS[m]>=ms){pos=m;hi=m-1}else lo=m+1}
      if (pos>0 && Math.abs(histMS[pos-1]-ms)<=Math.abs(histMS[pos]-ms)) pos=pos-1;
      // nearest Wednesday slot
      let best=0,bestd=1e18;
      for (let k=0;k<wedIdx.length;k++){
        const d = Math.abs(wedIdx[k]-pos); if (d<bestd){bestd=d;best=k;}
      }
      slider.value = best; chkToday.checked = false; onSlider();
    });
    figEl.on('plotly_hover', (ev)=>{ if (!panelOn||!ev||!ev.points||!ev.points.length) return; const p=ev.points[0]; setHoverCrosshair(p.x,p.y); updatePinnedHoverFromX(p.x); });
    figEl.on('plotly_unhover', ()=> clearHoverCrosshair());

    // Band crossing navigation
    function nearestIdx(ms, arr){ let lo=0,hi=arr.length-1,pos=hi; while(lo<=hi){const m=(lo+hi)>>1;if(arr[m]>=ms){pos=m;hi=m-1}else lo=m+1} if(pos>0&&Math.abs(arr[pos-1]-ms)<=Math.abs(arr[pos]-ms)) return pos-1; return pos; }
    function findCrossings(bandName, denom){
      const seriesBand = (denom==="USD")?ARR.usd[bandName]:(denom==="Gold")?ARR.gld[bandName]:ARR.spy[bandName];
      const px = (denom==="USD")?ARR.hist.usd:(denom==="Gold")?ARR.hist.gld:ARR.hist.spy;
      const out = [];
      for (let i=1;i<histMS.length;i++){
        const k0 = nearestIdx(histMS[i-1], fullMS);
        const k1 = nearestIdx(histMS[i], fullMS);
        const prev = px[i-1] - seriesBand[k0];
        const curr = px[i]   - seriesBand[k1];
        if (isFinite(prev)&&isFinite(curr) && ((prev<=0 && curr>=0) || (prev>=0 && curr<=0))) out.push(i);
      }
      return out;
    }
    function jumpCross(dir){
      const denom = denomSel.value;
      const key = document.getElementById('bandSel').value;
      const xs = findCrossings(key, denom);
      if (!xs.length) return;
      const cur = sliderToHistIndex();
      let target = null;
      if (dir<0){ for (let i=xs.length-1;i>=0;i--) if (xs[i]<cur){ target=xs[i]; break; } if (target===null) target=xs[0]; }
      else { for (let i=0;i<xs.length;i++) if (xs[i]>cur){ target=xs[i]; break; } if (target===null) target=xs.at(-1); }
      // set slider to the Wednesday slot closest to 'target'
      let best=0,bestd=1e18;
      for (let k=0;k<wedIdx.length;k++){ const d = Math.abs(wedIdx[k]-target); if (d<bestd){bestd=d;best=k;} }
      slider.value = best; chkToday.checked=false; onSlider();
    }
    prevBand.addEventListener('click', ()=>jumpCross(-1));
    nextBand.addEventListener('click', ()=>jumpCross(+1));

    // Export image + summary
    exportBtn.addEventListener('click', async ()=>{
      // Short summary
      const j = sliderToHistIndex(), dISO = histISO[j];
      const denom = denomSel.value;
      const price = denom==="USD"?ARR.hist.usd[j]: denom==="Gold"?ARR.hist.gld[j]: ARR.hist.spy[j];
      const ms = histMS[j];
      const k = (function(){let lo=0,hi=fullMS.length-1,pos=hi; while(lo<=hi){const m=(lo+hi)>>1;if(fullMS[m]>=ms){pos=m;hi=m-1}else lo=m+1} if(pos>0&&Math.abs(fullMS[pos-1]-ms)<=Math.abs(fullMS[pos]-ms)) return pos-1; return pos;})();
      const b = bandsAtIdx(k, denom);
      const zone = (function(v){ if(v<b.Support)return"SELL THE HOUSE!!"; if(v<b.Bear)return"Buy"; if(v<b.Frothy)return"DCA"; if(v<b.Top)return"Relax"; return"Frothy"; })(price);

      const summary =
        `BTC Purchase Indicator
Date: ${dISO}
Denomination: ${denom}
Zone: ${zone}`;

      console.log(summary);

      // Download image
      try{
        await Plotly.downloadImage(figEl, {format:'png', width:1280, height:720, filename:`btc-pl-${denom.toLowerCase()}-${dISO}`});
      }catch(e){ console.warn("downloadImage failed", e); }
      alert("Summary copied to console (Cmd/Ctrl+Shift+J). Image downloaded.");
    });

    // Init
    (function init(){
      setPanel(true);
      setDenom("USD");
      todayJump();
      window.addEventListener('resize', ()=> Plotly.Plots.resize(figEl));
    })();
  </script>
</body>
</html>
